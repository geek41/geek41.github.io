---
layout: view
comments: true
title: Map的线程安全问题
categories: java
tags: java
date: 2015-3-1
keywords: keyword
description: description
---

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> ConcurrentHashMap</h2>
<div class="outline-text-2" id="text-1">
<p>
实现原理:锁分离技术 (Lock Stripping)
</p>

<div class="org-src-container">

<pre class="src src-java"><span style="color: #F0DFAF; font-weight: bold;">public</span> <span style="color: #7CB8BB;">V</span> <span style="color: #93E0E3;">put</span>(<span style="color: #7CB8BB;">K</span> <span style="color: #DFAF8F;">key</span>, <span style="color: #7CB8BB;">V</span> <span style="color: #DFAF8F;">value</span>) {
    <span style="color: #7CB8BB;">Segment</span>&lt;<span style="color: #7CB8BB;">K</span>,<span style="color: #7CB8BB;">V</span>&gt; <span style="color: #DFAF8F;">s</span>;
    <span style="color: #F0DFAF; font-weight: bold;">if</span> (value == <span style="color: #BFEBBF;">null</span>)
        <span style="color: #F0DFAF; font-weight: bold;">throw</span> <span style="color: #F0DFAF; font-weight: bold;">new</span> <span style="color: #7CB8BB;">NullPointerException</span>();
    <span style="color: #7CB8BB;">int</span> <span style="color: #DFAF8F;">hash</span> = hash(key);
    <span style="color: #7CB8BB;">int</span> <span style="color: #DFAF8F;">j</span> = (hash &gt;&gt;&gt; segmentShift) &amp; segmentMask;
    <span style="color: #F0DFAF; font-weight: bold;">if</span> ((s = (Segment&lt;<span style="color: #7CB8BB;">K</span>,V&gt;)UNSAFE.getObject          <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">nonvolatile; recheck</span>
         (segments, (j &lt;&lt; SSHIFT) + SBASE)) == <span style="color: #BFEBBF;">null</span>) <span style="color: #5F7F5F;">//  </span><span style="color: #7F9F7F;">in ensureSegment</span>
        s = ensureSegment(j);
    <span style="color: #F0DFAF; font-weight: bold;">return</span> s.put(key, hash, value, <span style="color: #BFEBBF;">false</span>);
}
</pre>
</div>

<p>
通过段(Segment)来操作.在看segment的put方法.
</p>

<div class="org-src-container">

<pre class="src src-java"><span style="color: #F0DFAF; font-weight: bold;">static</span> <span style="color: #F0DFAF; font-weight: bold;">final</span> <span style="color: #F0DFAF; font-weight: bold;">class</span> <span style="color: #7CB8BB;">Segment</span>&lt;<span style="color: #7CB8BB;">K</span>,<span style="color: #7CB8BB;">V</span>&gt; <span style="color: #F0DFAF; font-weight: bold;">extends</span> <span style="color: #7CB8BB;">ReentrantLock</span> <span style="color: #F0DFAF; font-weight: bold;">implements</span> <span style="color: #7CB8BB;">Serializable</span> {
  <span style="color: #F0DFAF; font-weight: bold;">final</span> <span style="color: #7CB8BB;">V</span> <span style="color: #93E0E3;">put</span>(<span style="color: #7CB8BB;">K</span> <span style="color: #DFAF8F;">key</span>, <span style="color: #7CB8BB;">int</span> <span style="color: #DFAF8F;">hash</span>, <span style="color: #7CB8BB;">V</span> <span style="color: #DFAF8F;">value</span>, <span style="color: #7CB8BB;">boolean</span> <span style="color: #DFAF8F;">onlyIfAbsent</span>) {
            <span style="color: #7CB8BB;">HashEntry</span>&lt;<span style="color: #7CB8BB;">K</span>,<span style="color: #7CB8BB;">V</span>&gt; <span style="color: #DFAF8F;">node</span> = tryLock() ? <span style="color: #BFEBBF;">null</span> :
                scanAndLockForPut(key, hash, value);
      <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">....</span>
  }

 <span style="color: #F0DFAF; font-weight: bold;">private</span> <span style="color: #7CB8BB;">HashEntry</span>&lt;<span style="color: #7CB8BB;">K</span>,<span style="color: #7CB8BB;">V</span>&gt; <span style="color: #93E0E3;">scanAndLockForPut</span>(<span style="color: #7CB8BB;">K</span> <span style="color: #DFAF8F;">key</span>, <span style="color: #7CB8BB;">int</span> <span style="color: #DFAF8F;">hash</span>, <span style="color: #7CB8BB;">V</span> <span style="color: #DFAF8F;">value</span>) {
            <span style="color: #7CB8BB;">HashEntry</span>&lt;<span style="color: #7CB8BB;">K</span>,<span style="color: #7CB8BB;">V</span>&gt; <span style="color: #DFAF8F;">first</span> = entryForHash(<span style="color: #F0DFAF; font-weight: bold;">this</span>, hash);
            <span style="color: #7CB8BB;">HashEntry</span>&lt;<span style="color: #7CB8BB;">K</span>,<span style="color: #7CB8BB;">V</span>&gt; <span style="color: #DFAF8F;">e</span> = first;
            <span style="color: #7CB8BB;">HashEntry</span>&lt;<span style="color: #7CB8BB;">K</span>,<span style="color: #7CB8BB;">V</span>&gt; <span style="color: #DFAF8F;">node</span> = <span style="color: #BFEBBF;">null</span>;
            <span style="color: #7CB8BB;">int</span> <span style="color: #DFAF8F;">retries</span> = -1; <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">negative while locating node</span>
            <span style="color: #F0DFAF; font-weight: bold;">while</span> (<span style="color: #F0DFAF; font-weight: bold;">!</span>tryLock()) {
                <span style="color: #7CB8BB;">HashEntry</span>&lt;<span style="color: #7CB8BB;">K</span>,<span style="color: #7CB8BB;">V</span>&gt; <span style="color: #DFAF8F;">f</span>; <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">to recheck first below</span>
                <span style="color: #F0DFAF; font-weight: bold;">if</span> (retries &lt; 0) {
                    <span style="color: #F0DFAF; font-weight: bold;">if</span> (e == <span style="color: #BFEBBF;">null</span>) {
                        <span style="color: #F0DFAF; font-weight: bold;">if</span> (node == <span style="color: #BFEBBF;">null</span>) <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">speculatively create node</span>
                            node = <span style="color: #F0DFAF; font-weight: bold;">new</span> <span style="color: #7CB8BB;">HashEntry</span>&lt;<span style="color: #7CB8BB;">K</span>,<span style="color: #7CB8BB;">V</span>&gt;(hash, key, value, <span style="color: #BFEBBF;">null</span>);
                        retries = 0;
                    }
                    <span style="color: #F0DFAF; font-weight: bold;">else</span> <span style="color: #F0DFAF; font-weight: bold;">if</span> (key.equals(e.key))
                        retries = 0;
                    <span style="color: #F0DFAF; font-weight: bold;">else</span>
                        e = e.next;
                }
                <span style="color: #F0DFAF; font-weight: bold;">else</span> <span style="color: #F0DFAF; font-weight: bold;">if</span> (++retries &gt; MAX_SCAN_RETRIES) {
                    lock();
                    <span style="color: #F0DFAF; font-weight: bold;">break</span>;
                }
                <span style="color: #F0DFAF; font-weight: bold;">else</span> <span style="color: #F0DFAF; font-weight: bold;">if</span> ((retries &amp; 1) == 0 &amp;&amp;
                         (f = entryForHash(<span style="color: #F0DFAF; font-weight: bold;">this</span>, hash)) != first) {
                    e = first = f; <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">re-traverse if entry changed</span>
                    retries = -1;
                }
            }
            <span style="color: #F0DFAF; font-weight: bold;">return</span> node;
        }
}
</pre>
</div>

<p>
以上方法很明显有lock锁机制.在来看lock是怎么实现的.
</p>

<div class="org-src-container">

<pre class="src src-java">  <span style="color: #F0DFAF; font-weight: bold;">public</span> <span style="color: #F0DFAF; font-weight: bold;">class</span> <span style="color: #7CB8BB;">ReentrantLock</span> <span style="color: #F0DFAF; font-weight: bold;">implements</span> <span style="color: #7CB8BB;">Lock</span>, <span style="color: #BFEBBF;">java</span>.<span style="color: #BFEBBF;">io</span>.<span style="color: #7CB8BB;">Serializable</span> {
    <span style="color: #F0DFAF; font-weight: bold;">private</span> <span style="color: #F0DFAF; font-weight: bold;">static</span> <span style="color: #F0DFAF; font-weight: bold;">final</span> <span style="color: #7CB8BB;">long</span> <span style="color: #DFAF8F;">serialVersionUID</span> = 7373984872572414699L;
    <span style="color: #9FC59F;">/** Synchronizer providing all implementation mechanics */</span>
    <span style="color: #F0DFAF; font-weight: bold;">private</span> <span style="color: #F0DFAF; font-weight: bold;">final</span> <span style="color: #7CB8BB;">Sync</span> <span style="color: #DFAF8F;">sync</span>;

    <span style="color: #9FC59F;">/**</span>
<span style="color: #9FC59F;">     * Base of synchronization control for this lock. Subclassed</span>
<span style="color: #9FC59F;">     * into fair and nonfair versions below. Uses AQS state to</span>
<span style="color: #9FC59F;">     * represent the number of holds on the lock.</span>
<span style="color: #9FC59F;">     */</span>
    <span style="color: #F0DFAF; font-weight: bold;">abstract</span> <span style="color: #F0DFAF; font-weight: bold;">static</span> <span style="color: #F0DFAF; font-weight: bold;">class</span> <span style="color: #7CB8BB;">Sync</span> <span style="color: #F0DFAF; font-weight: bold;">extends</span> <span style="color: #7CB8BB;">AbstractQueuedSynchronizer</span> {
        <span style="color: #F0DFAF; font-weight: bold;">private</span> <span style="color: #F0DFAF; font-weight: bold;">static</span> <span style="color: #F0DFAF; font-weight: bold;">final</span> <span style="color: #7CB8BB;">long</span> <span style="color: #DFAF8F;">serialVersionUID</span> = -5179523762034025860L;

        <span style="color: #9FC59F;">/**</span>
<span style="color: #9FC59F;">         * Performs </span><span style="color: #9FC59F;">{@link Lock#lock}</span><span style="color: #9FC59F;">. The main reason for subclassing</span>
<span style="color: #9FC59F;">         * is to allow fast path for nonfair version.</span>
<span style="color: #9FC59F;">         */</span>
        <span style="color: #F0DFAF; font-weight: bold;">abstract</span> <span style="color: #7CB8BB;">void</span> <span style="color: #93E0E3;">lock</span>();
   }

<span style="color: #F0DFAF; font-weight: bold;">static</span> <span style="color: #F0DFAF; font-weight: bold;">final</span> <span style="color: #F0DFAF; font-weight: bold;">class</span> <span style="color: #7CB8BB;">NonfairSync</span> <span style="color: #F0DFAF; font-weight: bold;">extends</span> <span style="color: #7CB8BB;">Sync</span> {
        <span style="color: #F0DFAF; font-weight: bold;">private</span> <span style="color: #F0DFAF; font-weight: bold;">static</span> <span style="color: #F0DFAF; font-weight: bold;">final</span> <span style="color: #7CB8BB;">long</span> <span style="color: #DFAF8F;">serialVersionUID</span> = 7316153563782823691L;

        <span style="color: #9FC59F;">/**</span>
<span style="color: #9FC59F;">         * Performs lock.  Try immediate barge, backing up to normal</span>
<span style="color: #9FC59F;">         * acquire on failure.</span>
<span style="color: #9FC59F;">         */</span>
        <span style="color: #F0DFAF; font-weight: bold;">final</span> <span style="color: #7CB8BB;">void</span> <span style="color: #93E0E3;">lock</span>() {
            <span style="color: #F0DFAF; font-weight: bold;">if</span> (compareAndSetState(0, 1))
                setExclusiveOwnerThread(Thread.currentThread());
            <span style="color: #F0DFAF; font-weight: bold;">else</span>
                acquire(1);
        }

        <span style="color: #F0DFAF; font-weight: bold;">protected</span> <span style="color: #F0DFAF; font-weight: bold;">final</span> <span style="color: #7CB8BB;">boolean</span> <span style="color: #93E0E3;">tryAcquire</span>(<span style="color: #7CB8BB;">int</span> <span style="color: #DFAF8F;">acquires</span>) {
            <span style="color: #F0DFAF; font-weight: bold;">return</span> nonfairTryAcquire(acquires);
        }
    }

    <span style="color: #9FC59F;">/**</span>
<span style="color: #9FC59F;">     * Sync object for fair locks</span>
<span style="color: #9FC59F;">     */</span>
    <span style="color: #F0DFAF; font-weight: bold;">static</span> <span style="color: #F0DFAF; font-weight: bold;">final</span> <span style="color: #F0DFAF; font-weight: bold;">class</span> <span style="color: #7CB8BB;">FairSync</span> <span style="color: #F0DFAF; font-weight: bold;">extends</span> <span style="color: #7CB8BB;">Sync</span> {
        <span style="color: #F0DFAF; font-weight: bold;">private</span> <span style="color: #F0DFAF; font-weight: bold;">static</span> <span style="color: #F0DFAF; font-weight: bold;">final</span> <span style="color: #7CB8BB;">long</span> <span style="color: #DFAF8F;">serialVersionUID</span> = -3000897897090466540L;

        <span style="color: #F0DFAF; font-weight: bold;">final</span> <span style="color: #7CB8BB;">void</span> <span style="color: #93E0E3;">lock</span>() {
            acquire(1);
        }

        <span style="color: #9FC59F;">/**</span>
<span style="color: #9FC59F;">         * Fair version of tryAcquire.  Don't grant access unless</span>
<span style="color: #9FC59F;">         * recursive call or no waiters or is first.</span>
<span style="color: #9FC59F;">         */</span>
        <span style="color: #F0DFAF; font-weight: bold;">protected</span> <span style="color: #F0DFAF; font-weight: bold;">final</span> <span style="color: #7CB8BB;">boolean</span> <span style="color: #93E0E3;">tryAcquire</span>(<span style="color: #7CB8BB;">int</span> <span style="color: #DFAF8F;">acquires</span>) {
            <span style="color: #F0DFAF; font-weight: bold;">final</span> <span style="color: #7CB8BB;">Thread</span> <span style="color: #DFAF8F;">current</span> = Thread.currentThread();
            <span style="color: #7CB8BB;">int</span> <span style="color: #DFAF8F;">c</span> = getState();
            <span style="color: #F0DFAF; font-weight: bold;">if</span> (c == 0) {
                <span style="color: #F0DFAF; font-weight: bold;">if</span> (<span style="color: #F0DFAF; font-weight: bold;">!</span>hasQueuedPredecessors() &amp;&amp;
                    compareAndSetState(0, acquires)) {
                    setExclusiveOwnerThread(current);
                    <span style="color: #F0DFAF; font-weight: bold;">return</span> <span style="color: #BFEBBF;">true</span>;
                }
            }
            <span style="color: #F0DFAF; font-weight: bold;">else</span> <span style="color: #F0DFAF; font-weight: bold;">if</span> (current == getExclusiveOwnerThread()) {
                <span style="color: #7CB8BB;">int</span> <span style="color: #DFAF8F;">nextc</span> = c + acquires;
                <span style="color: #F0DFAF; font-weight: bold;">if</span> (nextc &lt; 0)
                    <span style="color: #F0DFAF; font-weight: bold;">throw</span> <span style="color: #F0DFAF; font-weight: bold;">new</span> <span style="color: #7CB8BB;">Error</span>(<span style="color: #CC9393;">"Maximum lock count exceeded"</span>);
                setState(nextc);
                <span style="color: #F0DFAF; font-weight: bold;">return</span> <span style="color: #BFEBBF;">true</span>;
            }
            <span style="color: #F0DFAF; font-weight: bold;">return</span> <span style="color: #BFEBBF;">false</span>;
        }
    }

    <span style="color: #9FC59F;">/**</span>
<span style="color: #9FC59F;">     * Creates an instance of </span><span style="color: #9FC59F;">{@code ReentrantLock}</span><span style="color: #9FC59F;">.</span>
<span style="color: #9FC59F;">     * This is equivalent to using </span><span style="color: #9FC59F;">{@code ReentrantLock(false)}</span><span style="color: #9FC59F;">.</span>
<span style="color: #9FC59F;">     */</span>
    <span style="color: #F0DFAF; font-weight: bold;">public</span> <span style="color: #93E0E3;">ReentrantLock</span>() {
        sync = <span style="color: #F0DFAF; font-weight: bold;">new</span> <span style="color: #7CB8BB;">NonfairSync</span>();
    }

    <span style="color: #9FC59F;">/**</span>
<span style="color: #9FC59F;">     * Creates an instance of </span><span style="color: #9FC59F;">{@code ReentrantLock}</span><span style="color: #9FC59F;"> with the</span>
<span style="color: #9FC59F;">     * given fairness policy.</span>
<span style="color: #9FC59F;">     *</span>
<span style="color: #9FC59F;">     * </span><span style="color: #9FC59F;">@param</span><span style="color: #9FC59F;"> fair </span><span style="color: #9FC59F;">{@code true}</span><span style="color: #9FC59F;"> if this lock should use a fair ordering policy</span>
<span style="color: #9FC59F;">     */</span>
    <span style="color: #F0DFAF; font-weight: bold;">public</span> <span style="color: #93E0E3;">ReentrantLock</span>(<span style="color: #7CB8BB;">boolean</span> <span style="color: #DFAF8F;">fair</span>) {
        sync = fair ? <span style="color: #F0DFAF; font-weight: bold;">new</span> <span style="color: #7CB8BB;">FairSync</span>() : <span style="color: #F0DFAF; font-weight: bold;">new</span> <span style="color: #7CB8BB;">NonfairSync</span>();
    }

    <span style="color: #9FC59F;">/**</span>
<span style="color: #9FC59F;">     * Acquires the lock.</span>
<span style="color: #9FC59F;">     *</span>
<span style="color: #9FC59F;">     * </span><span style="color: #9FC59F;">&lt;p&gt;</span><span style="color: #9FC59F;">Acquires the lock if it is not held by another thread and returns</span>
<span style="color: #9FC59F;">     * immediately, setting the lock hold count to one.</span>
<span style="color: #9FC59F;">     *</span>
<span style="color: #9FC59F;">     * </span><span style="color: #9FC59F;">&lt;p&gt;</span><span style="color: #9FC59F;">If the current thread already holds the lock then the hold</span>
<span style="color: #9FC59F;">     * count is incremented by one and the method returns immediately.</span>
<span style="color: #9FC59F;">     *</span>
<span style="color: #9FC59F;">     * </span><span style="color: #9FC59F;">&lt;p&gt;</span><span style="color: #9FC59F;">If the lock is held by another thread then the</span>
<span style="color: #9FC59F;">     * current thread becomes disabled for thread scheduling</span>
<span style="color: #9FC59F;">     * purposes and lies dormant until the lock has been acquired,</span>
<span style="color: #9FC59F;">     * at which time the lock hold count is set to one.</span>
<span style="color: #9FC59F;">     */</span>
    <span style="color: #F0DFAF; font-weight: bold;">public</span> <span style="color: #7CB8BB;">void</span> <span style="color: #93E0E3;">lock</span>() {
        sync.lock();
    }
</pre>
</div>



<!-- more -->
</div>
</div>
