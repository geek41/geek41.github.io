---
layout: view
comments: true
title: java模拟并发操作进行压力测试
categories: [java,test]
tags: [java,test]
date: 2013-1-10
keywords: java并发,压力测试
description: java并发,压力测试
---

<p>
java 压力测试.
</p>

<!-- more -->

<div class="org-src-container">

<pre class="src src-java"><span style="color: #F0DFAF; font-weight: bold;">import</span> <span style="color: #BFEBBF;">java</span>.<span style="color: #BFEBBF;">io</span>.<span style="color: #7CB8BB;">BufferedReader</span>;
<span style="color: #F0DFAF; font-weight: bold;">import</span> <span style="color: #BFEBBF;">java</span>.<span style="color: #BFEBBF;">io</span>.<span style="color: #7CB8BB;">File</span>;
<span style="color: #F0DFAF; font-weight: bold;">import</span> <span style="color: #BFEBBF;">java</span>.<span style="color: #BFEBBF;">io</span>.<span style="color: #7CB8BB;">FileInputStream</span>;
&#12288;&#12288;<span style="color: #F0DFAF; font-weight: bold;">import</span> <span style="color: #BFEBBF;">java</span>.<span style="color: #BFEBBF;">io</span>.<span style="color: #7CB8BB;">InputStreamReader</span>;
&#12288;&#12288;<span style="color: #F0DFAF; font-weight: bold;">import</span> <span style="color: #BFEBBF;">java</span>.<span style="color: #BFEBBF;">io</span>.<span style="color: #7CB8BB;">PrintWriter</span>;
&#12288;&#12288;<span style="color: #F0DFAF; font-weight: bold;">import</span> <span style="color: #BFEBBF;">java</span>.<span style="color: #BFEBBF;">net</span>.<span style="color: #7CB8BB;">HttpURLConnection</span>;
&#12288;&#12288;<span style="color: #F0DFAF; font-weight: bold;">import</span> <span style="color: #BFEBBF;">java</span>.<span style="color: #BFEBBF;">net</span>.<span style="color: #7CB8BB;">URL</span>;
&#12288;&#12288;<span style="color: #F0DFAF; font-weight: bold;">import</span> <span style="color: #BFEBBF;">java</span>.<span style="color: #BFEBBF;">util</span>.<span style="color: #7CB8BB;">HashMap</span>;
&#12288;&#12288;<span style="color: #F0DFAF; font-weight: bold;">import</span> <span style="color: #BFEBBF;">java</span>.<span style="color: #BFEBBF;">util</span>.<span style="color: #7CB8BB;">Map</span>;
&#12288;&#12288;<span style="color: #F0DFAF; font-weight: bold;">import</span> <span style="color: #BFEBBF;">java</span>.<span style="color: #BFEBBF;">util</span>.<span style="color: #BFEBBF;">concurrent</span>.<span style="color: #7CB8BB;">ExecutorService</span>;
&#12288;&#12288;<span style="color: #F0DFAF; font-weight: bold;">import</span> <span style="color: #BFEBBF;">java</span>.<span style="color: #BFEBBF;">util</span>.<span style="color: #BFEBBF;">concurrent</span>.<span style="color: #7CB8BB;">Executors</span>;
&#12288;&#12288;<span style="color: #F0DFAF; font-weight: bold;">import</span> <span style="color: #BFEBBF;">java</span>.<span style="color: #BFEBBF;">util</span>.<span style="color: #BFEBBF;">concurrent</span>.<span style="color: #7CB8BB;">Semaphore</span>;
&#12288;&#12288;<span style="color: #F0DFAF; font-weight: bold;">public</span> <span style="color: #F0DFAF; font-weight: bold;">class</span> ConcurrentTest {
    &#12288;&#12288;<span style="color: #F0DFAF; font-weight: bold;">private</span> <span style="color: #F0DFAF; font-weight: bold;">static</span> <span style="color: #7CB8BB;">int</span> thread_num = 200;
    &#12288;&#12288;<span style="color: #F0DFAF; font-weight: bold;">private</span> <span style="color: #F0DFAF; font-weight: bold;">static</span> <span style="color: #7CB8BB;">int</span> client_num = 460;
    &#12288;&#12288;<span style="color: #F0DFAF; font-weight: bold;">private</span> <span style="color: #F0DFAF; font-weight: bold;">static</span> Map keywordMap = <span style="color: #F0DFAF; font-weight: bold;">new</span> <span style="color: #7CB8BB;">HashMap</span>();
    &#12288;&#12288;<span style="color: #F0DFAF; font-weight: bold;">static</span> {
        &#12288;&#12288;<span style="color: #F0DFAF; font-weight: bold;">try</span> {
            &#12288;&#12288;InputStreamReader isr = <span style="color: #F0DFAF; font-weight: bold;">new</span> <span style="color: #7CB8BB;">InputStreamReader</span>(<span style="color: #F0DFAF; font-weight: bold;">new</span> <span style="color: #7CB8BB;">FileInputStream</span>(<span style="color: #F0DFAF; font-weight: bold;">new</span> <span style="color: #7CB8BB;">File</span>(<span style="color: #CC9393;">"clicks.txt"</span>)), <span style="color: #CC9393;">"GBK"</span>);
            &#12288;&#12288;BufferedReader buffer = <span style="color: #F0DFAF; font-weight: bold;">new</span> <span style="color: #7CB8BB;">BufferedReader</span>(isr);
            &#12288;&#12288;String line = <span style="color: #CC9393;">""</span>;
            &#12288;&#12288;<span style="color: #F0DFAF; font-weight: bold;">while</span> ((line = buffer.readLine()) != <span style="color: #BFEBBF;">null</span>) {
                &#12288;&#12288;keywordMap.put(line.substring(0, line.lastIndexOf(<span style="color: #CC9393;">":"</span>)), <span style="color: #CC9393;">""</span>);               &#12288;&#12288;}
            &#12288;&#12288;} <span style="color: #F0DFAF; font-weight: bold;">catch</span> (<span style="color: #7CB8BB;">Exception</span> <span style="color: #DFAF8F;">e</span>) {
            &#12288;&#12288;e.printStackTrace();
            &#12288;&#12288;}
        &#12288;&#12288;}
    &#12288;&#12288;<span style="color: #F0DFAF; font-weight: bold;">public</span> <span style="color: #F0DFAF; font-weight: bold;">static</span> <span style="color: #7CB8BB;">void</span> main(<span style="color: #7CB8BB;">String</span>[] <span style="color: #DFAF8F;">args</span>) {
        &#12288;&#12288;<span style="color: #7CB8BB;">int</span> size = keywordMap.size();
        &#12288;&#12288;<span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">TODO Auto-generated method stub</span>
            &#12288;&#12288;ExecutorService exec = Executors.newCachedThreadPool();
        &#12288;&#12288;<span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">50&#20010;&#32447;&#31243;&#21487;&#20197;&#21516;&#26102;&#35775;&#38382;</span>
            &#12288;&#12288;<span style="color: #F0DFAF; font-weight: bold;">final</span> Semaphore semp = <span style="color: #F0DFAF; font-weight: bold;">new</span> <span style="color: #7CB8BB;">Semaphore</span>(thread_num);
        &#12288;&#12288;<span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">&#27169;&#25311;2000&#20010;&#23458;&#25143;&#31471;&#35775;&#38382;</span>
            &#12288;&#12288;<span style="color: #F0DFAF; font-weight: bold;">for</span> (<span style="color: #7CB8BB;">int</span> <span style="color: #DFAF8F;">index</span> = 0; index &lt; <span style="color: #7CB8BB;">client_num</span>; index++) {
            &#12288;&#12288;<span style="color: #F0DFAF; font-weight: bold;">final</span> <span style="color: #7CB8BB;">int</span> NO = index;
            &#12288;&#12288;Runnable run = <span style="color: #F0DFAF; font-weight: bold;">new</span> <span style="color: #7CB8BB;">Runnable</span>() {
                &#12288;&#12288;<span style="color: #F0DFAF; font-weight: bold;">public</span> <span style="color: #7CB8BB;">void</span> run() {
                    &#12288;&#12288;<span style="color: #F0DFAF; font-weight: bold;">try</span> {
                        &#12288;&#12288;<span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">&#33719;&#21462;&#35768;&#21487;</span>
                        &#12288;&#12288;semp.acquire();
                            &#12288;&#12288;System.out.println(<span style="color: #CC9393;">"Thread:"</span> + NO);
                            &#12288;&#12288;String host = <span style="color: #CC9393;">"http://10.99.23.42:7001/KMQueryCenter/query.do?"</span>;
                            &#12288;&#12288;String para = <span style="color: #CC9393;">"method=getQueryResult&amp;pageNum=1&amp;pageSize=5&amp;"</span>
                                &#12288;&#12288;+ <span style="color: #CC9393;">"queryKeyWord="</span>
                                &#12288;&#12288;+ getRandomSearchKey(NO)
                                &#12288;&#12288;+ <span style="color: #CC9393;">"&amp;questionID=-1&amp;questionIdPath=-1&amp;searchType=1"</span>
                                &#12288;&#12288;+ <span style="color: #CC9393;">"&amp;proLine=&amp;proSeries=&amp;proType="</span> + NO;
                            &#12288;&#12288;System.out.println(host + para);
                            &#12288;&#12288;URL url = <span style="color: #F0DFAF; font-weight: bold;">new</span> <span style="color: #7CB8BB;">URL</span>(host);<span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">&#27492;&#22788;&#22635;&#20889;&#20379;&#27979;&#35797;&#30340;url</span>
                            &#12288;&#12288;HttpURLConnection connection = (<span style="color: #7CB8BB;">HttpURLConnection</span>) url
                                &#12288;&#12288;.openConnection();

                            &#12288;&#12288;<span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">connection.setRequestMethod("POST");</span>

                                &#12288;&#12288;<span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">connection.setRequestProperty("Proxy-Connection",</span>

                                &#12288;&#12288;<span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">"Keep-Alive");</span>

                                &#12288;&#12288;connection.setDoOutput(<span style="color: #BFEBBF;">true</span>);

                            &#12288;&#12288;connection.setDoInput(<span style="color: #BFEBBF;">true</span>);

                            &#12288;&#12288;PrintWriter out = <span style="color: #F0DFAF; font-weight: bold;">new</span> <span style="color: #7CB8BB;">PrintWriter</span>(connection

                                                                  &#12288;&#12288;.getOutputStream());

                            &#12288;&#12288;out.print(para);

                            &#12288;&#12288;out.flush();

                            &#12288;&#12288;out.close();

                            &#12288;&#12288;BufferedReader in = <span style="color: #F0DFAF; font-weight: bold;">new</span> <span style="color: #7CB8BB;">BufferedReader</span>(

                                                                       &#12288;&#12288;<span style="color: #F0DFAF; font-weight: bold;">new</span> <span style="color: #7CB8BB;">InputStreamReader</span>(connection

                                                                                                 &#12288;&#12288;.getInputStream()));
                            &#12288;&#12288;String line = <span style="color: #CC9393;">""</span>;
                            &#12288;&#12288;String result = <span style="color: #CC9393;">""</span>;
                            &#12288;&#12288;<span style="color: #F0DFAF; font-weight: bold;">while</span> ((line = in.readLine()) != <span style="color: #BFEBBF;">null</span>) {
                                &#12288;&#12288;result += line;
                                &#12288;&#12288;}
                            &#12288;&#12288;<span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">System.out.println(result);</span>

                                &#12288;&#12288;<span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">Thread.sleep((long) (Math.random()) * 1000);</span>
                                &#12288;&#12288;<span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">&#37322;&#25918;</span>
                                &#12288;&#12288;System.out.println(<span style="color: #CC9393;">"&#31532;&#65306;"</span> + NO + <span style="color: #CC9393;">" &#20010;"</span>);
                            &#12288;&#12288;semp.release();
                            &#12288;&#12288;} <span style="color: #F0DFAF; font-weight: bold;">catch</span> (<span style="color: #7CB8BB;">Exception</span> <span style="color: #DFAF8F;">e</span>) {
                            &#12288;&#12288;e.printStackTrace();
                            &#12288;&#12288;}
                        &#12288;&#12288;}
                    &#12288;&#12288;};
            &#12288;&#12288;exec.execute(run);
            &#12288;&#12288;}
        &#12288;&#12288;<span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">&#36864;&#20986;&#32447;&#31243;&#27744;</span>
            &#12288;&#12288;exec.shutdown();
        &#12288;&#12288;}
    &#12288;&#12288;<span style="color: #F0DFAF; font-weight: bold;">private</span> <span style="color: #F0DFAF; font-weight: bold;">static</span> String getRandomSearchKey(<span style="color: #F0DFAF; font-weight: bold;">final</span> <span style="color: #7CB8BB;">int</span> <span style="color: #DFAF8F;">no</span>) {
        &#12288;&#12288;String ret = <span style="color: #CC9393;">""</span>;
        &#12288;&#12288;<span style="color: #7CB8BB;">int</span> size = keywordMap.size();
        &#12288;&#12288;<span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">int wanna = (int) (Math.random()) * (size - 1);</span>
            &#12288;&#12288;ret = (keywordMap.entrySet().toArray())[no].toString();
        &#12288;&#12288;ret = ret.substring(0, ret.lastIndexOf(<span style="color: #CC9393;">"="</span>));
        &#12288;&#12288;System.out.println(<span style="color: #CC9393;">"\t"</span> + ret);
        &#12288;&#12288;<span style="color: #F0DFAF; font-weight: bold;">return</span> ret;
        &#12288;&#12288;}

    &#12288;&#12288;}
</pre>
</div>
