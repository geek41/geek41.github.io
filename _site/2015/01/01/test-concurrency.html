<!DOCTYPE html>
<html>
  <head>
	　<meta http-equiv="content-type" content="text/html; charset=utf-8" />
	　<title>Geek 41|java模拟并发操作进行压力测试</title>
	<link rel="stylesheet" href="/assets/stylesheets/bootstrap.min.css" type="text/css" media="screen" />
	<link rel="stylesheet" href="http://fonts.useso.com/css?family=Rancho&effect=shadow-multiple|3d-float" type="text/css" media="screen" />
	
	<style type="text/css" media="screen">
	  @font-face {
      font-family: monaco;
      src: url('/assets/fonts/Monaco_Linux.ttf');
	  }
	  * {font-family:monaco,"文泉驿等宽微米黑";font-size:13px;}
	  #logo span{font-family:"楷体";font-size:16px;text-shadow:none;margin:20px;}
	  .h2 h2{font-size:20px;}
	  .post h2{font-size:18px;padding-bottom:8px;border-bottom: 1px dotted #ccc;}
	  .title-block{border-bottom: 1px dotted #ccc;}
	  .commit{padding:5px;}
	</style>
  </head>

  <body>

	  　<div class="org-src-container">

<pre class="src src-java">import java.io.BufferedReader;

　　import java.io.File;

　　import java.io.FileInputStream;

　　import java.io.InputStreamReader;

　　import java.io.PrintWriter;

　　import java.net.HttpURLConnection;

　　import java.net.URL;

　　import java.util.HashMap;

　　import java.util.Map;

　　import java.util.concurrent.ExecutorService;

　　import java.util.concurrent.Executors;

　　import java.util.concurrent.Semaphore;

　　public class ConcurrentTest {

　　private static int thread_num = 200;

　　private static int client_num = 460;

　　private static Map keywordMap = new HashMap();

　　static {

　　try {

　　InputStreamReader isr = new InputStreamReader(new FileInputStream(

　　new File("clicks.txt")), "GBK");

　　BufferedReader buffer = new BufferedReader(isr);

　　String line = "";

　　while ((line = buffer.readLine()) != null) {

　　keywordMap.put(line.substring(0, line.lastIndexOf(":")), "");

　　}

　　} catch (Exception e) {

　　e.printStackTrace();

　　}

　　}

　　public static void main(String[] args) {

　　int size = keywordMap.size();

　　// TODO Auto-generated method stub

　　ExecutorService exec = Executors.newCachedThreadPool();

　　// 50个线程可以同时访问

　　final Semaphore semp = new Semaphore(thread_num);

　　// 模拟2000个客户端访问

　　for (int index = 0; index &lt; client_num; index++) {

　　final int NO = index;

　　Runnable run = new Runnable() {

　　public void run() {

　　try {

　　// 获取许可

　　semp.acquire();

　　System.out.println("Thread:" + NO);

　　String host = "http://10.99.23.42:7001/KMQueryCenter/query.do?";

　　String para = "method=getQueryResult&amp;pageNum=1&amp;pageSize=5&amp;"

　　+ "queryKeyWord="

　　+ getRandomSearchKey(NO)

　　+ "&amp;questionID=-1&amp;questionIdPath=-1&amp;searchType=1"

　　+ "&amp;proLine=&amp;proSeries=&amp;proType=" + NO;

　　System.out.println(host + para);

　　URL url = new URL(host);// 此处填写供测试的url

　　HttpURLConnection connection = (HttpURLConnection) url

　　.openConnection();

　　// connection.setRequestMethod("POST");

　　// connection.setRequestProperty("Proxy-Connection",

　　// "Keep-Alive");

　　connection.setDoOutput(true);

　　connection.setDoInput(true);

　　PrintWriter out = new PrintWriter(connection

　　.getOutputStream());

　　out.print(para);

　　out.flush();

　　out.close();

　　BufferedReader in = new BufferedReader(

　　new InputStreamReader(connection

　　.getInputStream()));

　　String line = "";

　　String result = "";

　　while ((line = in.readLine()) != null) {

　　result += line;

　　}

　　// System.out.println(result);

　　// Thread.sleep((long) (Math.random()) * 1000);

　　// 释放

　　System.out.println("第：" + NO + " 个");

　　semp.release();

　　} catch (Exception e) {

　　e.printStackTrace();

　　}

　　}

　　};

　　exec.execute(run);

　　}

　　// 退出线程池

　　exec.shutdown();

　　}

　　private static String getRandomSearchKey(final int no) {

　　String ret = "";

　　int size = keywordMap.size();

　　// int wanna = (int) (Math.random()) * (size - 1);

　　ret = (keywordMap.entrySet().toArray())[no].toString();

　　ret = ret.substring(0, ret.lastIndexOf("="));

　　System.out.println("\t" + ret);

　　return ret;

　　}

　　}
</pre>
</div>


	<script>
	  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

	  ga('create', 'UA-47157282-1', 'geek41.github.io');
	  ga('send', 'pageview');

	</script>
  </body>

</html>
